<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Momin Receipt</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* SAME STYLES AS BEFORE â€” unchanged */
*{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
body{background:linear-gradient(145deg,#1e3a8a,#3b82f6);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px;}
.container{background:#ffffff;border-radius:16px;box-shadow:0 10px 20px rgba(0,0,0,0.15);padding:32px;width:100%;max-width:500px;text-align:center;transition:transform 0.3s ease;}
.container:hover{transform:translateY(-5px);}
h1,h2{color:#1e3a8a;margin-bottom:24px;font-weight:700;}
.btn{display:block;width:100%;padding:14px;margin:12px 0;font-size:1rem;font-weight:600;color:#fff;background:#3b82f6;border:none;border-radius:8px;cursor:pointer;transition:background 0.3s ease, transform 0.2s ease;}
.btn:hover{background:#2563eb;transform:scale(1.02);}
.btn.whatsapp{background:#25d366;}
.btn.whatsapp:hover{background:#128c7e;}
.btn.print{background:#6b7280;}
.btn.print:hover{background:#4b5563;}
input,textarea{width:100%;padding:12px;margin-bottom:16px;border-radius:8px;border:1px solid #d1d5db;font-size:1rem;transition:border-color 0.3s ease;}
input:focus,textarea:focus{outline:none;border-color:#3b82f6;}
textarea{resize:none;height:160px;}
.hidden{display:none;}
.toggle-btn{display:inline-block;width:48%;margin:8px 1%;padding:10px;border-radius:8px;border:none;font-weight:600;color:#fff;cursor:pointer;transition:background 0.3s ease;}
.open{background:#22c55e;}
.open:hover{background:#16a34a;}
.close{background:#ef4444;}
.close:hover{background:#dc2626;}
.day{background:#f59e0b;}
.day:hover{background:#d97706;}
.night{background:#7c3aed;}
.night:hover{background:#6d28d9;}
.total-container{margin:16px 0;font-size:1.1rem;font-weight:600;color:#1e3a8a;}
#previewContainer{position:absolute;top:-9999px;left:-9999px;background:#fff;padding:20px;width:302px;text-align:left;font-family:'Courier',monospace;font-size:12px;line-height:1.5;}
.error-msg{color:red;margin-bottom:12px;font-weight:600;}
</style>
</head>
<body>

<!-- LOGIN PAGE -->
<div class="container" id="loginPage">
<h1>Login</h1>
<div class="error-msg" id="loginError"></div>
<input type="text" id="keyInput" placeholder="Enter Key">
<button class="btn" onclick="login()">Login</button>
</div>

<!-- WELCOME PAGE -->
<div class="container hidden" id="welcomePage">
<h1>Momin Receipt</h1>
<button class="btn" onclick="showPage('bazarPage')">Notes</button>
<button class="btn" onclick="showPage('onlinePage')">Online Customer</button>
</div>

<!-- BAZAR PAGE -->
<div class="container hidden" id="bazarPage">
<h2>Bazar Name</h2>
<button class="btn" onclick="openBazar('Sridevi')">Sridevi</button>
<button class="btn" onclick="openBazar('Time')">Time</button>
<button class="btn" onclick="openBazar('Milan')">Milan</button>
<button class="btn" onclick="openBazar('Kalyan')">Kalyan</button>
<button class="btn" onclick="openBazar('Bombay Night')">Bombay Night</button>
<button class="btn" onclick="showPage('welcomePage')">Back</button>
</div>

<!-- BAZAR NOTES PAGE -->
<div class="container hidden" id="bazarNotesPage">
<h2 id="bazarTitle">Bazar</h2>
<div id="togglesContainer"></div>
<textarea id="bazarNotes" placeholder="Type notes for this bazar..."></textarea>
<div class="total-container">Total: <span id="total">0</span></div>
<div class="combined-btn">
<button class="btn whatsapp" id="shareWhatsappBtn">Share WhatsApp</button>
<button class="btn print" id="printBtn">Print</button>
</div>
<button class="btn" id="downloadBtn">Download PDF</button>
<button class="btn" id="downloadJpgBtn">Download JPG</button>
<button class="btn" onclick="showPage('bazarPage')">Back</button>
</div>

<!-- ONLINE CUSTOMER PAGE -->
<div class="container hidden" id="onlinePage">
<h2>Online Customer</h2>
<input type="text" id="customerName" placeholder="Customer Name">
<input type="number" id="amount" placeholder="Amount">
<textarea id="details" placeholder="Notes / Details"></textarea>
<div class="combined-btn">
<button class="btn whatsapp" onclick="saveCustomerWhatsapp()">Share WhatsApp</button>
<button class="btn print" onclick="saveCustomerPrint()">Print</button>
</div>
<button class="btn" onclick="showPage('welcomePage')">Back</button>
</div>

<div id="previewContainer"></div>

<script>
// ============ CONFIG ============
const API_URL = "https://momin-key-server.onrender.com"; // Render backend URL
let deviceID = localStorage.getItem("deviceID");
if (!deviceID) {
  deviceID = "dev-" + Math.random().toString(36).substr(2, 9);
  localStorage.setItem("deviceID", deviceID);
}

// ============ LOGIN ============
async function login() {
  const key = document.getElementById("keyInput").value.trim();
  const errorDiv = document.getElementById("loginError");
  errorDiv.textContent = "";
  if (!key) return (errorDiv.textContent = "Please enter key");

  try {
    const res = await fetch(`${API_URL}/validate-key`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ key }),
    });
    const data = await res.json();
    if (data.success) {
      localStorage.setItem("authKey", key);
      showPage("welcomePage");
    } else {
      errorDiv.textContent = "Invalid key!";
    }
  } catch (err) {
    errorDiv.textContent = "Error connecting to server";
  }
}

// ============ PAGE SWITCH ============
function showPage(pageId) {
  document.querySelectorAll(".container").forEach((c) => c.classList.add("hidden"));
  document.getElementById(pageId).classList.remove("hidden");
}

// ============ BAZAR ============
let currentBazar = "";
let openCloseState = "Open";
let dayNightState = "Day";
const WHATSAPP_NUMBER = "9270112074";

function openBazar(name) {
  currentBazar = name;
  document.getElementById("bazarTitle").textContent = name;
  document.getElementById("bazarNotes").value = "";
  setupToggles(name);
  loadCloudNotes(name);
  showPage("bazarNotesPage");
}

function setupToggles(name) {
  const container = document.getElementById("togglesContainer");
  container.innerHTML = `
    <button class="toggle-btn open" id="openCloseBtn" onclick="toggleOpenClose()">Open</button>
    ${name !== "Bombay Night" ? '<button class="toggle-btn day" id="dayNightBtn" onclick="toggleDayNight()">Day</button>' : ""}
  `;
}

function toggleOpenClose() {
  const btn = document.getElementById("openCloseBtn");
  openCloseState = openCloseState === "Open" ? "Close" : "Open";
  btn.textContent = openCloseState;
  btn.className = `toggle-btn ${openCloseState.toLowerCase()}`;
}

function toggleDayNight() {
  const btn = document.getElementById("dayNightBtn");
  dayNightState = dayNightState === "Day" ? "Night" : "Day";
  btn.textContent = dayNightState;
  btn.className = `toggle-btn ${dayNightState.toLowerCase()}`;
}

// ============ CLOUD SAVE/LOAD ============
async function saveCloudNotes() {
  const notes = document.getElementById("bazarNotes").value;
  await fetch(`${API_URL}/save-data`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ deviceID, notes }),
  });
}

async function loadCloudNotes() {
  try {
    const res = await fetch(`${API_URL}/load-data?deviceID=${deviceID}`);
    const data = await res.json();
    document.getElementById("bazarNotes").value = data.notes || "";
  } catch (err) {
    console.warn("Cloud load failed");
  }
}

document.getElementById("bazarNotes").addEventListener("input", saveCloudNotes);

// ============ TOTAL CALCULATION ============
function computeDeepTotal(text) {
  const lines = text.split("\n").map((l) => l.trim()).filter((l) => l);
  let total = 0;
  for (let i = 0; i < lines.length; i++) {
    const m = lines[i].match(/\((\d+)\)/);
    if (!m) continue;
    total += parseInt(m[1]);
  }
  return total;
}

const textarea = document.getElementById("bazarNotes");
const totalSpan = document.getElementById("total");
textarea.addEventListener("input", () => {
  totalSpan.textContent = computeDeepTotal(textarea.value);
});

// ============ (All PDF, JPG, Print functions remain same) ============
</script>
</body>
</html>
