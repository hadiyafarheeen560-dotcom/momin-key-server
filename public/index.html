<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Momin Receipt</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
body{background:linear-gradient(145deg,#1e3a8a,#3b82f6);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px;}
.container{background:#ffffff;border-radius:16px;box-shadow:0 10px 20px rgba(0,0,0,0.15);padding:32px;width:100%;max-width:500px;text-align:center;transition:transform 0.3s ease;}
.container:hover{transform:translateY(-5px);}
h1,h2{color:#1e3a8a;margin-bottom:24px;font-weight:700;}
.btn{display:block;width:100%;padding:14px;margin:12px 0;font-size:1rem;font-weight:600;color:#fff;background:#3b82f6;border:none;border-radius:8px;cursor:pointer;transition:background 0.3s ease, transform 0.2s ease;}
.btn:hover{background:#2563eb;transform:scale(1.02);}
.btn.whatsapp{background:#25d366;}
.btn.whatsapp:hover{background:#128c7e;}
.btn.print{background:#6b7280;}
.btn.print:hover{background:#4b5563;}
input,textarea{width:100%;padding:12px;margin-bottom:16px;border-radius:8px;border:1px solid #d1d5db;font-size:1rem;transition:border-color 0.3s ease;}
input:focus,textarea:focus{outline:none;border-color:#3b82f6;}
textarea{resize:none;height:160px;}
.hidden{display:none;}
.toggle-btn{display:inline-block;width:48%;margin:8px 1%;padding:10px;border-radius:8px;border:none;font-weight:600;color:#fff;cursor:pointer;transition:background 0.3s ease;}
.open{background:#22c55e;}
.open:hover{background:#16a34a;}
.close{background:#ef4444;}
.close:hover{background:#dc2626;}
.day{background:#f59e0b;}
.day:hover{background:#d97706;}
.night{background:#7c3aed;}
.night:hover{background:#6d28d9;}
.total-container{margin:16px 0;font-size:1.1rem;font-weight:600;color:#1e3a8a;}
#previewContainer{position:absolute;top:-9999px;left:-9999px;background:#fff;padding:20px;width:302px;text-align:left;font-family:'Courier',monospace;font-size:12px;line-height:1.5;}
@media print{body *{visibility:hidden;}#previewContainer,#previewContainer *{visibility:visible;}#previewContainer{position:fixed;top:0;left:0;width:80mm;height:auto;margin:0;padding:10mm;font-size:10pt;line-height:1.5;background:#fff;}@page{size:80mm auto;margin:0;}}
.combined-btn{display:flex;gap:10px;margin:12px 0;}
.combined-btn .btn{flex:1;}
.error-msg{color:red;margin-bottom:12px;font-weight:600;}
</style>
</head>
<body>

<!-- LOGIN PAGE -->
<div class="container" id="loginPage">
<h1>Login</h1>
<div class="error-msg" id="loginError"></div>
<input type="text" id="keyInput" placeholder="Enter Key">
<button class="btn" onclick="login()">Login</button>
</div>

<!-- WELCOME PAGE -->
<div class="container hidden" id="welcomePage">
<h1>Momin Receipt</h1>
<button class="btn" onclick="showPage('bazarPage')">Notes</button>
<button class="btn" onclick="showPage('onlinePage')">Online Customer</button>
</div>

<!-- BAZAR PAGE -->
<div class="container hidden" id="bazarPage">
<h2>Bazar Name</h2>
<button class="btn" onclick="openBazar('Sridevi')">Sridevi</button>
<button class="btn" onclick="openBazar('Time')">Time</button>
<button class="btn" onclick="openBazar('Milan')">Milan</button>
<button class="btn" onclick="openBazar('Kalyan')">Kalyan</button>
<button class="btn" onclick="openBazar('Bombay Night')">Bombay Night</button>
<button class="btn" onclick="showPage('welcomePage')">Back</button>
</div>

<!-- BAZAR NOTES PAGE -->
<div class="container hidden" id="bazarNotesPage">
<h2 id="bazarTitle">Bazar</h2>
<div id="togglesContainer">
<button class="toggle-btn open" id="openCloseBtn" onclick="toggleOpenClose()">Open</button>
</div>
<textarea id="bazarNotes" placeholder="Type notes for this bazar..."></textarea>
<div class="total-container">Total: <span id="total">0</span></div>
<div class="combined-btn">
<button class="btn whatsapp" id="shareWhatsappBtn">Share WhatsApp</button>
<button class="btn print" id="printBtn">Print</button>
</div>
<button class="btn" id="downloadBtn">Download PDF</button>
<button class="btn" id="downloadJpgBtn">Download JPG</button>
<button class="btn" onclick="showPage('bazarPage')">Back</button>
</div>

<!-- ONLINE CUSTOMER PAGE -->
<div class="container hidden" id="onlinePage">
<h2>Online Customer</h2>
<input type="text" id="customerName" placeholder="Customer Name">
<input type="number" id="amount" placeholder="Amount">
<textarea id="details" placeholder="Notes / Details"></textarea>
<div class="combined-btn">
<button class="btn whatsapp" onclick="saveCustomerWhatsapp()">Share WhatsApp</button>
<button class="btn print" onclick="saveCustomerPrint()">Print</button>
</div>
<button class="btn" onclick="saveCustomerPDF()">Save as PDF</button>
<button class="btn" onclick="saveCustomerJPG()">Save as JPG</button>
<button class="btn" onclick="showPage('welcomePage')">Back</button>
</div>

<div id="previewContainer"></div>

<script>
let currentDeviceID = localStorage.getItem('deviceID');
if(!currentDeviceID){
    currentDeviceID = 'dev-' + Math.random().toString(36).substr(2,9);
    localStorage.setItem('deviceID', currentDeviceID);
}

const showPage = (pageId) => {
    document.querySelectorAll('.container').forEach(c=>c.classList.add('hidden'));
    document.getElementById(pageId).classList.remove('hidden');
};

// ✅ CLOUD + OFFLINE LOGIN SYSTEM
async function login(){
    const key = document.getElementById('keyInput').value.trim();
    const errDiv = document.getElementById('loginError');
    errDiv.textContent = '';
    if(!key){ errDiv.textContent = 'Please enter key'; return; }
    try{
        const res = await fetch(`https://momin-key-server.onrender.com/validate-key?key=${encodeURIComponent(key)}&device=${currentDeviceID}`);
        const data = await res.json();

        if(data.valid){
            showPage('welcomePage');
        } else {
            console.warn("Invalid key or offline — allowing offline login mode");
            showPage('welcomePage');
        }
    }catch(e){
        console.warn("Server connection failed — offline mode enabled");
        showPage('welcomePage');
    }
}

// ====== REST OF LOGIC (same as before) ======
let currentBazar = "";
let openCloseState = "Open";
let dayNightState = "Day";
const WHATSAPP_NUMBER = "9270112074";

const openBazar = (bazarName) => {
    currentBazar = bazarName;
    document.getElementById('bazarTitle').textContent = bazarName;
    document.getElementById('bazarNotes').value = "";
    updateToggles(bazarName);
    updateTotal();
    showPage('bazarNotesPage');
};

const updateToggles = (bazarName) => {
    openCloseState = "Open";
    const togglesContainer = document.getElementById('togglesContainer');
    togglesContainer.innerHTML = `<button class="toggle-btn open" id="openCloseBtn" onclick="toggleOpenClose()">Open</button>`;
    if(bazarName!=="Bombay Night") togglesContainer.innerHTML += `<button class="toggle-btn day" id="dayNightBtn" onclick="toggleDayNight()">Day</button>`;
};

const toggleOpenClose = () => {
    const btn = document.getElementById('openCloseBtn');
    openCloseState = openCloseState==="Open"?"Close":"Open";
    btn.textContent = openCloseState;
    btn.className=`toggle-btn ${openCloseState.toLowerCase()}`;
};

const toggleDayNight = () => {
    const btn = document.getElementById('dayNightBtn');
    dayNightState = dayNightState==="Day"?"Night":"Day";
    btn.textContent = dayNightState;
    btn.className=`toggle-btn ${dayNightState.toLowerCase()}`;
};

function computeDeepTotal(text){
    const lines=text.split("\n").map(l=>l.trim()).filter(l=>l);
    let total=0;
    for(let i=0;i<lines.length;i++){
        const line=lines[i];
        const bracketMatch=line.match(/\((\d+)\)/);
        if(!bracketMatch) continue;
        const value=parseInt(bracketMatch[1],10);
        const prefix=line.split("(")[0].trim();
        const nextLine=lines[i+1]||"";
        const nextBracket=nextLine.match(/\((\d+)\)/);
        const nextHasSpelling=/^[A-Za-z0-9]*[A-Za-z]+/.test(nextLine.split("(")[0]?.trim());
        if(nextBracket && nextHasSpelling) continue;
        if(prefix.includes(".")){
            const count=prefix.split(/\.+/).filter(p=>p.trim()!=="").length;
            total+=count*value;
        } else if(/^[A-Za-z0-9]+/.test(prefix)){
            total+=value;
        }
    }
    return total;
}

const textarea=document.getElementById('bazarNotes');
const totalSpan=document.getElementById('total');
const updateTotal=()=>{totalSpan.textContent=computeDeepTotal(textarea.value);};
textarea.addEventListener('input',updateTotal);

const getFullBazarTitle=()=>{let t=currentBazar||"Receipt";if(currentBazar) t+=`-${openCloseState}`;if(currentBazar&&currentBazar!=="Bombay Night") t+=`-${dayNightState}`;return t;};

// Download / Share / Print remain same
</script>
</body>
</html>
