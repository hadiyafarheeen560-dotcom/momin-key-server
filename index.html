<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Momin Receipt</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"><script>
async function validateLogin() {
  const key = document.getElementById("keyInput").value.trim();
  if (!key) {
    alert("Please enter your key");
    return;
  }

  // Generate or fetch stored deviceID
  const deviceID = localStorage.getItem("deviceID") || crypto.randomUUID();
  localStorage.setItem("deviceID", deviceID);

  // Fetch from your live backend
  const response = await fetch(`https://momin-key-server.onrender.com/validate-key?key=${key}`);
  const data = await response.json();

  if (data.valid) {
    if (!data.device || data.device === deviceID) {
      alert("✅ Login Successful!");
      document.getElementById("loginPage").style.display = "none";
      document.getElementById("mainApp").style.display = "block";
    } else {
      alert("❌ This key is already used on another device");
    }
  } else {
    alert("❌ Invalid Key");
  }
}
</script>
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
body{background:linear-gradient(145deg,#1e3a8a,#3b82f6);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px;}
.container{background:#ffffff;border-radius:16px;box-shadow:0 10px 20px rgba(0,0,0,0.15);padding:32px;width:100%;max-width:500px;text-align:center;transition:transform 0.3s ease;}
.container:hover{transform:translateY(-5px);}
h1,h2{color:#1e3a8a;margin-bottom:24px;font-weight:700;}
.btn{display:block;width:100%;padding:14px;margin:12px 0;font-size:1rem;font-weight:600;color:#fff;background:#3b82f6;border:none;border-radius:8px;cursor:pointer;transition:background 0.3s ease, transform 0.2s ease;}
.btn:hover{background:#2563eb;transform:scale(1.02);}
.btn.whatsapp{background:#25d366;}
.btn.whatsapp:hover{background:#128c7e;}
.btn.print{background:#6b7280;}
.btn.print:hover{background:#4b5563;}
input,textarea{width:100%;padding:12px;margin-bottom:16px;border-radius:8px;border:1px solid #d1d5db;font-size:1rem;transition:border-color 0.3s ease;}
input:focus,textarea:focus{outline:none;border-color:#3b82f6;}
textarea{resize:none;height:160px;}
.hidden{display:none;}
.toggle-btn{display:inline-block;width:48%;margin:8px 1%;padding:10px;border-radius:8px;border:none;font-weight:600;color:#fff;cursor:pointer;transition:background 0.3s ease;}
.open{background:#22c55e;}
.open:hover{background:#16a34a;}
.close{background:#ef4444;}
.close:hover{background:#dc2626;}
.day{background:#f59e0b;}
.day:hover{background:#d97706;}
.night{background:#7c3aed;}
.night:hover{background:#6d28d9;}
.total-container{margin:16px 0;font-size:1.1rem;font-weight:600;color:#1e3a8a;}
#previewContainer{position:absolute;top:-9999px;left:-9999px;background:#fff;padding:20px;width:302px;text-align:left;font-family:'Courier',monospace;font-size:12px;line-height:1.5;}
@media print{body *{visibility:hidden;}#previewContainer,#previewContainer *{visibility:visible;}#previewContainer{position:fixed;top:0;left:0;width:80mm;height:auto;margin:0;padding:10mm;font-size:10pt;line-height:1.5;background:#fff;}@page{size:80mm auto;margin:0;}}
.combined-btn{display:flex;gap:10px;margin:12px 0;}
.combined-btn .btn{flex:1;}
.error-msg{color:red;margin-bottom:12px;font-weight:600;}
</style>
</head>
<body>

<!-- LOGIN PAGE -->
<div class="container" id="loginPage">
<h1>Login</h1>
<div class="error-msg" id="loginError"></div>
<input type="text" id="keyInput" placeholder="Enter Key">
<button class="btn" onclick="login()">Login</button>
</div>

<!-- WELCOME PAGE -->
<div class="container hidden" id="welcomePage">
<h1>Momin Receipt</h1>
<button class="btn" onclick="showPage('bazarPage')">Notes</button>
<button class="btn" onclick="showPage('onlinePage')">Online Customer</button>
</div>

<!-- BAZAR PAGE -->
<div class="container hidden" id="bazarPage">
<h2>Bazar Name</h2>
<button class="btn" onclick="openBazar('Sridevi')">Sridevi</button>
<button class="btn" onclick="openBazar('Time')">Time</button>
<button class="btn" onclick="openBazar('Milan')">Milan</button>
<button class="btn" onclick="openBazar('Kalyan')">Kalyan</button>
<button class="btn" onclick="openBazar('Bombay Night')">Bombay Night</button>
<button class="btn" onclick="showPage('welcomePage')">Back</button>
</div>

<!-- BAZAR NOTES PAGE -->
<div class="container hidden" id="bazarNotesPage">
<h2 id="bazarTitle">Bazar</h2>
<div id="togglesContainer">
<button class="toggle-btn open" id="openCloseBtn" onclick="toggleOpenClose()">Open</button>
</div>
<textarea id="bazarNotes" placeholder="Type notes for this bazar..."></textarea>
<div class="total-container">Total: <span id="total">0</span></div>
<div class="combined-btn">
<button class="btn whatsapp" id="shareWhatsappBtn">Share WhatsApp</button>
<button class="btn print" id="printBtn">Print</button>
</div>
<button class="btn" id="downloadBtn">Download PDF</button>
<button class="btn" id="downloadJpgBtn">Download JPG</button>
<button class="btn" onclick="showPage('bazarPage')">Back</button>
</div>

<!-- ONLINE CUSTOMER PAGE -->
<div class="container hidden" id="onlinePage">
<h2>Online Customer</h2>
<input type="text" id="customerName" placeholder="Customer Name">
<input type="number" id="amount" placeholder="Amount">
<textarea id="details" placeholder="Notes / Details"></textarea>
<div class="combined-btn">
<button class="btn whatsapp" onclick="saveCustomerWhatsapp()">Share WhatsApp</button>
<button class="btn print" onclick="saveCustomerPrint()">Print</button>
</div>
<button class="btn" onclick="saveCustomerPDF()">Save as PDF</button>
<button class="btn" onclick="saveCustomerJPG()">Save as JPG</button>
<button class="btn" onclick="showPage('welcomePage')">Back</button>
</div>

<div id="previewContainer"></div>

<script>
let currentDeviceID = localStorage.getItem('deviceID');
if(!currentDeviceID){
    currentDeviceID = 'dev-' + Math.random().toString(36).substr(2,9);
    localStorage.setItem('deviceID', currentDeviceID);
}

const showPage = (pageId) => {
    document.querySelectorAll('.container').forEach(c=>c.classList.add('hidden'));
    document.getElementById(pageId).classList.remove('hidden');
};

async function login(){
    const key = document.getElementById('keyInput').value.trim();
    const errDiv = document.getElementById('loginError');
    errDiv.textContent = '';
    if(!key){ errDiv.textContent = 'Please enter key'; return; }
    try{
        const res = await fetch(`http://localhost:3000/validate-key?key=${encodeURIComponent(key)}&device=${currentDeviceID}`);
        const data = await res.json();
        if(!data.valid){ errDiv.textContent = 'Invalid Key'; return; }
        if(data.device && data.device!==currentDeviceID){ errDiv.textContent = 'Key already used on another device'; return; }
        showPage('welcomePage');
    }catch(e){
        errDiv.textContent = 'Error connecting to server';
    }
}

// ===== BAZAR LOGIC =====
let currentBazar = "";
let openCloseState = "Open";
let dayNightState = "Day";
const WHATSAPP_NUMBER = "9270112074";

const openBazar = (bazarName) => {
    currentBazar = bazarName;
    document.getElementById('bazarTitle').textContent = bazarName;
    document.getElementById('bazarNotes').value = "";
    updateToggles(bazarName);
    updateTotal();
    showPage('bazarNotesPage');
};

const updateToggles = (bazarName) => {
    openCloseState = "Open";
    const togglesContainer = document.getElementById('togglesContainer');
    togglesContainer.innerHTML = `<button class="toggle-btn open" id="openCloseBtn" onclick="toggleOpenClose()">Open</button>`;
    if(bazarName!=="Bombay Night") togglesContainer.innerHTML += `<button class="toggle-btn day" id="dayNightBtn" onclick="toggleDayNight()">Day</button>`;
};

const toggleOpenClose = () => {
    const btn = document.getElementById('openCloseBtn');
    openCloseState = openCloseState==="Open"?"Close":"Open";
    btn.textContent = openCloseState;
    btn.className=`toggle-btn ${openCloseState.toLowerCase()}`;
};

const toggleDayNight = () => {
    const btn = document.getElementById('dayNightBtn');
    dayNightState = dayNightState==="Day"?"Night":"Day";
    btn.textContent = dayNightState;
    btn.className=`toggle-btn ${dayNightState.toLowerCase()}`;
};

// ===== DEEP TOTAL CALCULATION =====
function computeDeepTotal(text){
    const lines=text.split("\n").map(l=>l.trim()).filter(l=>l);
    let total=0;
    for(let i=0;i<lines.length;i++){
        const line=lines[i];
        const bracketMatch=line.match(/\((\d+)\)/);
        if(!bracketMatch) continue;
        const value=parseInt(bracketMatch[1],10);
        const prefix=line.split("(")[0].trim();
        const nextLine=lines[i+1]||"";
        const nextBracket=nextLine.match(/\((\d+)\)/);
        const nextHasSpelling=/^[A-Za-z0-9]*[A-Za-z]+/.test(nextLine.split("(")[0]?.trim());
        if(nextBracket && nextHasSpelling) continue;
        if(prefix.includes(".")){
            const count=prefix.split(/\.+/).filter(p=>p.trim()!=="").length;
            total+=count*value;
        } else if(/^[A-Za-z0-9]+/.test(prefix)){
            total+=value;
        }
    }
    return total;
}

const textarea=document.getElementById('bazarNotes');
const totalSpan=document.getElementById('total');
const updateTotal=()=>{totalSpan.textContent=computeDeepTotal(textarea.value);};
textarea.addEventListener('input',updateTotal);

const getFullBazarTitle=()=>{let t=currentBazar||"Receipt";if(currentBazar) t+=`-${openCloseState}`;if(currentBazar&&currentBazar!=="Bombay Night") t+=`-${dayNightState}`;return t;};

const generatePreviewContent=()=>{ 
    const bazarTitle=getFullBazarTitle().toUpperCase();
    const now=new Date();
    const notes=textarea.value.split('\n').filter(l=>l.trim());
    const total=totalSpan.textContent||'0';
    return `
    <div style="text-align:center;font-weight:bold;font-size:14px;">${bazarTitle}</div>
    <div style="display:flex;justify-content:space-between;margin-top:10px;">
        <div style="font-size:10px;">
            <div>Date: ${now.toLocaleDateString()}</div>
            <div>Time: ${now.toLocaleTimeString()}</div>
        </div>
        <div style="font-size:27px;font-weight:bold;">GS</div>
    </div>
    <div style="margin:10px 0;">-------------------------------</div>
    <div style="font-size:10px;text-align:left;">${notes.map(l=>`<div>${l}</div>`).join('')}</div>
    <div style="margin:10px 0;">-------------------------------</div>
    <div style="text-align:center;font-weight:bold;font-size:12px;">TOTAL: ${total}</div>
    `;
};

// ===== DOWNLOAD / SHARE / PRINT (same as previous) =====
// Download PDF
document.getElementById('downloadBtn').addEventListener('click',()=>{
    const { jsPDF }=window.jspdf;
    const doc=new jsPDF({unit:'mm',format:[80,300]});
    let y=10;
    const bazarTitle=getFullBazarTitle().toUpperCase();
    doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.text(bazarTitle,40,y,{align:'center'}); y+=8;
    const now=new Date();
    doc.setFont('helvetica','normal'); doc.setFontSize(10);
    doc.text(`Date: ${now.toLocaleDateString()}`,10,y); doc.text(`Time: ${now.toLocaleTimeString()}`,10,y+7);
    doc.setFont('helvetica','bold'); doc.setFontSize(27); doc.text('GS',60,y+5); y+=14;
    doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.text('-------------------------------',10,y); y+=10;
    doc.setFontSize(9);
    const lines=textarea.value.split('\n').filter(l=>l.trim());
    lines.forEach(l=>{const wrapped=doc.splitTextToSize(l,60); doc.text(wrapped,10,y); y+=wrapped.length*5;});
    doc.text('-------------------------------',10,y); y+=7; doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.text(`TOTAL: ${totalSpan.textContent||'0'}`,40,y,{align:'center'});
    const finalHeight=y+10; doc.setPage(1); doc.internal.pageSize.height=finalHeight;
    doc.save(`${bazarTitle}.pdf`);
});

// Download JPG
document.getElementById('downloadJpgBtn').addEventListener('click',()=>{
    const previewContainer=document.getElementById('previewContainer');
    previewContainer.innerHTML=generatePreviewContent();
    html2canvas(previewContainer,{scale:3.78,width:302,height:previewContainer.offsetHeight}).then(canvas=>{
        const imgData=canvas.toDataURL('image/jpeg',0.9);
        const link=document.createElement('a'); link.href=imgData; link.download=`${getFullBazarTitle()}.jpg`; link.click();
    });
});

// WhatsApp Share
document.getElementById('shareWhatsappBtn').addEventListener('click',()=>{
    const previewContainer=document.getElementById('previewContainer');
    previewContainer.innerHTML=generatePreviewContent();
    html2canvas(previewContainer,{scale:3.78,width:302,height:previewContainer.offsetHeight}).then(canvas=>{
        const imgData=canvas.toDataURL('image/jpeg',0.9);
        const link=document.createElement('a'); link.href=imgData; link.download=`${getFullBazarTitle()}.jpg`; link.click();
        const url=`https://wa.me/${WHATSAPP_NUMBER}`; window.open(url,'_blank');
    });
});

// Print
document.getElementById('printBtn').addEventListener('click',()=>{
    const previewContainer=document.getElementById('previewContainer');
    previewContainer.innerHTML=generatePreviewContent();
    previewContainer.style.position='fixed'; previewContainer.style.top='0'; previewContainer.style.left='0';
    previewContainer.style.width='80mm'; previewContainer.style.height='auto'; previewContainer.style.background='#fff';
    previewContainer.style.zIndex='9999'; previewContainer.style.padding='10mm';
    window.print();
    setTimeout(()=>{previewContainer.innerHTML=''; previewContainer.style.position='absolute';
    previewContainer.style.top='-9999px'; previewContainer.style.left='-9999px'; previewContainer.style.width='302px';
    previewContainer.style.height='auto'; previewContainer.style.zIndex='auto'; previewContainer.style.padding='20px';},1000);
});
</script>
</body>
</html>
